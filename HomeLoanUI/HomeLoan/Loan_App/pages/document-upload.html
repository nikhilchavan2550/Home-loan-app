<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Document Manager</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 text-gray-800 h-screen overflow-y-auto">
<div class="max-w-6xl mx-auto p-6 overflow-x-auto min-h-[90vh]">
  <h1 class="text-3xl font-bold mb-8 text-center">Home Loan Document Manager</h1>

  <!-- Upload Form -->
  <form id="documentForm" class="space-y-4 bg-white p-6 rounded shadow-md">
    <div id="responseAlert" class="hidden px-4 py-2 rounded text-sm font-medium"></div>

    <input type="hidden" id="personalId">
    <input type="hidden" id="editId">

    <div>
      <label for="documentType" class="block font-medium mb-1">Document Type *</label>
      <select id="documentType" class="w-full border rounded px-3 py-2" required>
        <option value="">Choose typeâ€¦</option>
      </select>
    </div>

    <div>
      <label for="fileInput" class="block font-medium mb-1">Select File *</label>
      <input type="file" id="fileInput" class="w-full border rounded px-3 py-2" accept=".pdf,.doc,.docx">
    </div>

 

    <div id="deleteModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
  <div class="bg-white rounded-lg p-6 w-full max-w-md shadow-xl animate-fadeIn">
    <div class="flex items-center justify-between mb-4 border-b pb-2">
      <h2 class="text-lg font-semibold text-black">Confirm Deletion</h2>
      <button onclick="hideDeleteModal()" class="text-gray-500 hover:text-gray-700 text-xl">&times;</button>
    </div>
    <div class="mb-6">
      <p class="text-gray-700">Are you sure you want to delete this document?</p>
      <p class="text-sm text-gray-500 mt-1">This action cannot be undone.</p>
    </div>
    <div class="flex justify-end gap-3">
      <button onclick="hideDeleteModal()" class="px-4 py-2 bg-gray-200 text-gray-800 rounded hover:bg-gray-300">Cancel</button>
      <button onclick="proceedDelete()" class="px-4 py-2 bg-black text-white rounded hover:bg-gray-800">Delete</button>
    </div>
  </div>
</div>


    <div class="flex items-center gap-4">
      <button type="submit" class="bg-black text-white px-4 py-2 rounded hover:bg-gray-800 flex items-center gap-2" id="submitBtn">
        <span id="submitText">Upload Document</span>
        <span id="submitSpinner" class="hidden animate-spin w-4 h-4 border-2 border-white border-t-transparent rounded-full"></span>
      </button>
      <div class="w-full bg-gray-200 rounded h-3">
        <div id="progressFill" class="h-full bg-green-500 rounded w-0 transition-all"></div>
      </div>
    </div>
  </form>

  <!-- Documents Table -->
  <!-- Documents Table -->
<div class="mt-10 mb-16">
  <div id="recordsMessage" class="text-sm text-red-600 hidden mb-4"></div>
  <div class="overflow-auto max-h-[60vh] rounded">
    <table class="min-w-full text-sm text-left bg-white shadow rounded">
      <thead class="bg-gray-200 text-gray-700 uppercase">
        <tr>
          <th class="p-3">File Name</th>
          <th class="p-3">Cust ID</th>
          <th class="p-3">Status</th>
          <th class="p-3">File</th>
          <th class="p-3">Uploaded</th>
          <th class="p-3">Actions</th>
        </tr>
      </thead>
      <tbody id="documentsTableBody" class="divide-y">
        <!-- Rows injected here -->
      </tbody>
    </table>
  </div>
</div>

</div>

<script>
const API_BASE = "http://localhost:8086/api/documents";
let pendingDeleteId = null;

const fileTypes = {
  'Pan Card': 'PAN_CARD',
  'Voter id': 'VOTER_ID',
  'Salary Slip': 'SALARY_SLIP',
  'LOA': 'LOA',
  'NOC from Builder': 'NOC_FROM_BUILDER',
  'Agreement to Sale': 'AGREEMENT_TO_SALE',
  'Aadhar Card': 'AADHAR_CARD',
  'Passport': 'PASSPORT',
  'Driving License': 'DRIVING_LICENSE',
  'Bank Statement': 'BANK_STATEMENT',
  'Property Documents': 'PROPERTY_DOCUMENTS',
  'Other': 'OTHER',
  'Aadhaar Card': 'AADHAAR',
  'Income Proof': 'INCOME_PROOF',
  'Property Proof': 'PROPERTY_PROOF',
  'Photo': 'PHOTO'
};

function confirmDelete(id) {
  pendingDeleteId = id;
  document.getElementById('deleteModal').classList.remove('hidden');
}

function hideDeleteModal() {
  document.getElementById('deleteModal').classList.add('hidden');
  pendingDeleteId = null;
}

async function proceedDelete() {
  if (!pendingDeleteId) return;

  try {
    const resp = await fetch(`${API_BASE}/delete/${pendingDeleteId}`, { method: "DELETE" });
    if (!resp.ok) throw new Error("Failed to delete document");
    hideDeleteModal();
    loadDocuments();
  } catch (err) {
    alert("Error deleting document: " + err.message);
    hideDeleteModal();
  }
}


document.addEventListener("DOMContentLoaded", () => {
  const customerData = JSON.parse(localStorage.getItem("customerData"));
  if (customerData?.customerId) {
    document.getElementById("personalId").value = customerData.customerId;
  }

  const select = document.getElementById("documentType");
  for (const [label, value] of Object.entries(fileTypes)) {
    const option = document.createElement("option");
    option.value = value;
    option.textContent = label;
    select.appendChild(option);
  }

  loadDocuments();
});

function showAlert(el, type, msg) {
  el.className = `px-4 py-2 rounded text-sm font-medium ${type === "success" ? "bg-green-100 text-green-800" : "bg-red-100 text-red-800"}`;
  el.textContent = msg;
  el.classList.remove("hidden");
}
function resetAlert(el) {
  el.classList.add("hidden");
}
function updateProgress(pct) {
  document.getElementById("progressFill").style.width = pct + "%";
}

document.getElementById("documentForm").addEventListener("submit", async e => {
  e.preventDefault();
  const alertEl = document.getElementById("responseAlert");
  const submitBtn = document.getElementById("submitBtn");
  const spinner = document.getElementById("submitSpinner");

  submitBtn.disabled = true;
  spinner.classList.remove("hidden");
  resetAlert(alertEl);

  const custid = document.getElementById("personalId").value;
  const fileType = document.getElementById("documentType").value;
  const fileInput = document.getElementById("fileInput");
  const file = fileInput.files[0];
  const editId = document.getElementById("editId").value;

  if (!custid || !fileType || (!file && !editId)) {
    showAlert(alertEl, "error", "Please fill all required fields.");
    submitBtn.disabled = false;
    spinner.classList.add("hidden");
    return;
  }

  if (file && file.size > 5 * 1024 * 1024) {
    showAlert(alertEl, "error", "File size must be less than or equal to 5MB.");
    submitBtn.disabled = false;
    spinner.classList.add("hidden");
    return;
  }

  if (editId) {
    // Update status / metadata
    try {
      const resp = await fetch(`${API_BASE}/update/${editId}`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ status: "SUBMITTED", fileType, custid })
      });
      if (!resp.ok) throw new Error(await resp.text());
      showAlert(alertEl, "success", "Document updated successfully.");
    } catch (err) {
      showAlert(alertEl, "error", err.message);
    }
  } else {
    const fd = new FormData();
    fd.append("custid", custid);
    fd.append("fileType", fileType);
    fd.append("status", "SUBMITTED");
    fd.append("file", file);

    try {
      const resp = await fetch(`${API_BASE}/upload`, { method: "POST", body: fd });
      if (!resp.ok) throw new Error(await resp.text());
      showAlert(alertEl, "success", "Document uploaded successfully.");
    } catch (err) {
      showAlert(alertEl, "error", err.message);
    }
  }

  document.getElementById("documentForm").reset();
  document.getElementById("editId").value = "";
  document.getElementById("submitText").textContent = "Upload Document";
  updateProgress(0);
  submitBtn.disabled = false;
  spinner.classList.add("hidden");
  loadDocuments();
});


async function loadDocuments() {
  const tbody = document.getElementById("documentsTableBody");
  const msg = document.getElementById("recordsMessage");
  tbody.innerHTML = "";
  msg.classList.add("hidden");

  const customerData = JSON.parse(localStorage.getItem("customerData"));
  const custid = customerData?.customerId;

  if (!custid) {
    msg.textContent = "Customer ID not found in local storage.";
    msg.classList.remove("hidden");
    return;
  }

  try {
    const resp = await fetch(`${API_BASE}/customer/${custid}`);
    if (!resp.ok) throw new Error(resp.statusText);
    const docs = await resp.json();
    if (docs.length === 0) {
      tbody.innerHTML = `<tr><td colspan="6" class="text-center text-gray-500 py-4">No documents found for your account.</td></tr>`;
      return;
    }

    tbody.innerHTML = docs.map(d => `
      <tr>
        <td class="p-3">${d.fileName}</td>
        <td class="p-3">${d.custid}</td>
        <td class="p-3">${d.status}</td>
        <td class="p-3">
          <a href="${API_BASE}/download/${d.id}" class="text-blue-600 hover:underline">Download</a>
        </td>
        <td class="p-3">${new Date(d.uploadTime).toLocaleString()}</td>
        <td class="p-3">
          <button onclick="editDocument(${d.id})" class="text-yellow-600 hover:underline">Edit</button>
          <button onclick="confirmDelete(${d.id})" class="text-red-600 hover:underline ml-4">Delete</button>
        </td>
      </tr>
    `).join("");
  } catch (err) {
    msg.textContent = `Error loading documents: ${err.message}`;
    msg.classList.remove("hidden");
  }
}

async function editDocument(id) {
  try {
    const resp = await fetch(`${API_BASE}/${id}`);
    if (!resp.ok) throw new Error("Failed to fetch document");
    const doc = await resp.json();
    document.getElementById("editId").value = doc.id;
    document.getElementById("documentType").value = doc.fileType;
    document.getElementById("submitText").textContent = "Update Document";
    window.scrollTo({ top: 0, behavior: "smooth" });
  } catch (err) {
    alert("Error loading document for editing: " + err.message);
  }
}

// async function confirmDelete(id) {
//   if (!confirm("Are you sure you want to delete this document?")) return;
//   try {
//     const resp = await fetch(`${API_BASE}/delete/${id}`, { method: "DELETE" });
//     if (!resp.ok) throw new Error("Failed to delete document");
//     loadDocuments();
//   } catch (err) {
//     alert("Error deleting document: " + err.message);
//   }
// }
</script>
</body>
</html>
